# 写入大量数据时设置合理的bulk size

## 使用bulk请求

批量请求将产生比单文档索引请求更好的性能。为了知道批量请求的最佳大小，您应该在一个节点上运行一个带有单个`shard`的基准。首先尝试一次索引100个文档，然后是200，然后是400，等等，在每次基准测试运行中，将批量请求中的文档数量增加一倍。当索引速度开始趋于平稳时，您就知道您达到了对数据的批量请求的最佳大小。要注意的是，当许多请求并发地发送时，过大的批量请求可能会使集群处于内存压力之下，因此最好避免在每次请求时超过几十兆字节，即使较大的请求看起来性能更好。

## 使用多个线程发送数据至Elasticsearch

发送大量请求的单个线程不太可能最大限度地完全使用ES的索引容量。为了使用集群的所有资源，您应该从多个线程或进程发送数据。除了更好地利用集群的资源之外，这应该有助于降低每个fsync的成本。

请务必注意`TOO_MANY_REQUESTS(429)响应码`(Java的EsRejectedExecutionException)，这是Elasticsearch告诉您它无法跟上当前索引率的方式。当这种情况发生时，您应该在再次尝试之前暂停索引，最好是使用随机指数备份。

与批量请求相似，只有测试才能确定最佳线程数量。这可以通过逐步增加线程数量来测试，直到集群上的I/O或CPU饱和为止。
# 选择合适的主片和复制片

## 合理的主片和复制片设置

何为合理的设置？就是索引的shard能均匀分配到每个节点上，不合理设置可能会导致集群节点负载不均衡，严重的会导致查询性能下降。一般公式为`shards = primary * (replic+1)`，最后得出的shards数量可以被集群节点数整除。如果集群节点数量很多，这个就按需分配。

举例，一个有3个节点的集群，如何设置索引的主片和复制片才是合理的？主片1，复制片2；主片3，复制片1；主片6，复制片1; 这些配置的索引的shard都能平均分配到集群节点上。如何按需配置，请继续往下读。

## 按需配置
> 现在假设你有一个索引和两个节点。在一种情况下，主片设置为3，复制片的数量为0，这意味着每个节点拥有一个`shard`。在第二种情况下，复制片的数量为1，这意味着每个节点有两个`shard`。哪种设置在搜索性能上表现最好? 

### 每个节点上更少shard，更快的搜索速度

第一种情况下，每个节点一个shard。每个节点的`shard`总数较少的设置会执行得更好。原因在于，它为每个`shard`提供了更大的可用文件系统缓存份额，而文件系统缓存可能是Elasticsearch的头号性能因素。与此同时，要注意，没有副本的设置在出现单个节点故障时可能会出现故障，因此在吞吐量和可用性之间需要进行权衡。

### 更多复制片，更高的吞吐量

第二种情况下，索引设置为2个主片，1个复制片，这样每个节点至少有该索引的2个shard。虽然查询时没有第一种情况下快。因为每个节点2个shard的原因，索引时的吞吐量比第一种情况更佳。

### 索引复制片数量公式

那么正确的副本数量是多少? 如果您有一个`num_nodes`节点的集群，主片数量为`num_primary` primary shards，如果您希望能够同时处理`max_failure` 节点失败，那么您需要的正确复制片数量是 `max(max_failure, ceil(num_nodes / num_primar_node) - 1)`。

举例，有一个5节点的集群，一个索引主片5个，希望2个节点挂点的情况下，数据不丢失。那么`max(2, ceil(5/5)-1)=2`